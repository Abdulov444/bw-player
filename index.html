<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bleeding Wounds — Player</title>
<meta name="theme-color" content="#0b0b0d"/>
<link rel="manifest" href="manifest.webmanifest?v=5">
<link rel="icon" href="icons/bw-192.png" sizes="192x192">
<link rel="icon" href="icons/bw-512.png" sizes="512x512">
<style>
:root{--bg:#0b0b0d;--panel:#0f0f12;--muted:#1a1a20;--line:#24242b;--text:#f2f2f7;--sub:#b9b9c4;--accent:#d3162f;--accent2:#8f0f22}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
.container{max-width:920px;margin:0 auto;padding:14px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent),#3b0d14)}
.title h1{margin:0;font-size:18px;font-weight:800}
.title p{margin:2px 0 0;color:var(--sub);font-size:12px}

/* tabs */
.tabs{margin:12px 0;display:flex;gap:8px;overflow:auto;padding-bottom:6px}
.tab{border:1px solid var(--line);background:var(--panel);color:#cfd; padding:10px 14px;border-radius:12px;white-space:nowrap;flex:0 0 auto}
.tab.active{background:linear-gradient(180deg,var(--accent),var(--accent2));border-color:#520d18;color:#fff}

/* card */
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);border:1px solid var(--line);border-radius:16px;overflow:hidden}
.card h2{margin:0;padding:12px 14px;background:linear-gradient(180deg,#131318,#0e0e12);border-bottom:1px solid var(--line);font-size:14px;text-transform:uppercase;letter-spacing:.5px}
.body{padding:12px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.row > *{min-width:120px}
input[type=text],textarea,select{width:100%;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px 12px;color:var(--text);outline:none}
textarea{min-height:72px;resize:vertical}
.btn{border:0;border-radius:12px;padding:10px 14px;color:#fff;background:linear-gradient(180deg,var(--accent),var(--accent2));cursor:pointer}
.btn.muted{background:linear-gradient(180deg,#1c1c22,#121216);color:#cbd; border:1px solid var(--line)}
.btn.ghost{background:transparent;color:#cbd;border:1px dashed var(--line)}
.hint{color:#a8a8b6;font-size:12px}

/* list */
.list{display:flex;flex-direction:column}
.item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;padding:12px;border-bottom:1px solid #1f1f26}
@media (max-width:560px){.item{grid-template-columns:1fr;}}
.badge{font-size:12px;border:1px solid #2b2b33;border-radius:999px;padding:4px 8px;color:#d8d8e2}
.audio{width:100%}
.time{color:#9aa;font-size:12px}
.nowrap{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* star (favorite) */
.star{width:32px;height:32px;border-radius:10px;border:1px solid var(--line);background:var(--panel);display:grid;place-items:center;cursor:pointer}
.star.active{background:linear-gradient(180deg,#ffd54d,#ff9800);color:#000;border-color:#d68a00}
.kv{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="brand">
      <div class="logo">BW</div>
      <div class="title">
        <h1>Bleeding Wounds — Player</h1>
        <p id="subtitle">Хуячим песенки</p>
      </div>
    </div>
    <div class="kv">
      <span id="userRole" class="hint">Гость</span>
      <button class="btn muted" id="signBtn">Войти</button>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab active" id="tabCatalog">Каталог</button>
    <button class="tab" id="tabUpload">Загрузка</button>
    <button class="tab" id="tabFav">Избранное</button>
    <button class="tab" id="tabSettings">Настройки</button>
  </nav>

  <!-- Каталог -->
  <section class="screen" id="screenCatalog">
    <div class="card">
      <h2>Каталог наработок</h2>
      <div class="body">
        <div class="row">
          <input id="q" type="text" placeholder="Поиск: название, теги, тональность, bpm…">
          <select id="tagFilter">
            <option value="">Все теги</option>
            <option>riff</option><option>idea</option><option>demo</option><option>mix</option><option>live</option><option>import</option>
          </select>
          <select id="sortBy">
            <option value="date">Сначала новые</option>
            <option value="title">По названию</option>
          </select>
          <button class="btn muted" id="exportBtn">Экспорт</button>
          <input type="file" id="importFile" accept="application/json" hidden>
          <button class="btn ghost" id="importBtn">Импорт</button>
        </div>
        <div class="list" id="list"></div>
      </div>
    </div>
  </section>

  <!-- Загрузка -->
  <section class="screen" id="screenUpload" style="display:none">
    <div class="card">
      <h2>Загрузка</h2>
      <div class="body">
        <div class="row">
          <input id="title" type="text" placeholder="Название">
          <select id="tag"><option>riff</option><option>idea</option><option>demo</option><option>mix</option><option>live</option></select>
        </div>
        <div class="row">
          <input id="key" type="text" placeholder="Тональность (напр. D# minor)">
          <input id="bpm" type="text" placeholder="BPM (напр. 180)">
        </div>
        <textarea id="notes" placeholder="Заметки (структура, инструменты, идеи)"></textarea>
        <div class="row"><input id="file" type="file" accept="audio/*"></div>
        <div class="row" style="justify-content:space-between">
          <span class="hint">Файл → Supabase Storage, метаданные → БД. Локальная копия для офлайна.</span>
          <button class="btn" id="addBtn">Добавить</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Избранное -->
  <section class="screen" id="screenFav" style="display:none">
    <div class="card">
      <h2>Избранное</h2>
      <div class="body">
        <div class="list" id="favList"></div>
      </div>
    </div>
  </section>

  <!-- Настройки -->
  <section class="screen" id="screenSettings" style="display:none">
    <div class="card">
      <h2>Настройки</h2>
      <div class="body">
        <div class="row">
          <label class="hint">Скорость воспроизведения</label>
          <select id="playbackRate">
            <option value="1">1.0×</option>
            <option value="1.25">1.25×</option>
            <option value="1.5">1.5×</option>
            <option value="2">2×</option>
          </select>
        </div>
        <div class="row">
          <button class="btn muted" id="refreshBtn">Обновить каталог</button>
          <button class="btn ghost" id="clearBtn">Очистить офлайн-кеш</button>
        </div>
        <p class="hint">PWA: после обновлений иногда нужно переустановить иконку с экрана, чтобы подтянулся новый кэш.</p>
      </div>
    </div>
  </section>

  <p class="hint">Установи на Android через «⋮ → Добавить на главный экран» — офлайн поддерживается.</p>
</div>

<script>if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== Supabase ===== */
const SUPABASE_URL  = "https://acjoymwoecbknquonsre.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjam95bXdvZWNia25xdW9uc3JlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MzExMjIsImV4cCI6MjA3NDIwNzEyMn0.9lxvRik9dt6IZLLuN_HVOoK63v_cBKnNqdKkAJ4TTVo";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
async function ensureAnon(){const {data:{user}}=await supabase.auth.getUser(); if(!user) await supabase.auth.signInAnonymously();}
ensureAnon();

/* ===== IndexedDB ===== */
const DB='bw-player-db', STORE='tracks';
function idb(){return new Promise((res,rej)=>{const r=indexedDB.open(DB,1);r.onupgradeneeded=()=>{const db=r.result;const s=db.createObjectStore(STORE,{keyPath:'id'});s.createIndex('by_tag','tag');};r.onerror=()=>rej(r.error);r.onsuccess=()=>res(r.result);});}
async function dbReadAll(){const db=await idb();return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readonly');const s=tx.objectStore(STORE);const q=s.getAll();q.onsuccess=()=>res(q.result.sort((a,b)=>b.created-a.created));q.onerror=()=>rej(q.error);});}
async function dbPut(o){const db=await idb();return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readwrite');tx.objectStore(STORE).put(o);tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);});}
async function dbDelete(id){const db=await idb();return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readwrite');tx.objectStore(STORE).delete(id);tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);});}

/* ===== Auth по коду ===== */
const INVITE_CODE='BW-2025';
const localAuth={get role(){return localStorage.getItem('bw_role')||'guest'},signIn(c){if(c===INVITE_CODE){localStorage.setItem('bw_role','member');return true}return false},signOut(){localStorage.removeItem('bw_role')}};

/* ===== Favorites ===== */
function favSet(){return new Set(JSON.parse(localStorage.getItem('bw_favs')||'[]'))}
function favSave(set){localStorage.setItem('bw_favs',JSON.stringify([...set]))}
function favHas(id){return favSet().has(id)}
function favToggle(id){const s=favSet(); s.has(id)?s.delete(id):s.add(id); favSave(s); render(); renderFav();}

/* ===== UI state ===== */
const els={
  tabCatalog:byId('tabCatalog'), tabUpload:byId('tabUpload'), tabFav:byId('tabFav'), tabSettings:byId('tabSettings'),
  screenCatalog:byId('screenCatalog'), screenUpload:byId('screenUpload'), screenFav:byId('screenFav'), screenSettings:byId('screenSettings'),
  list:byId('list'), favList:byId('favList'),
  q:byId('q'), tagFilter:byId('tagFilter'), sortBy:byId('sortBy'),
  title:byId('title'), tag:byId('tag'), key:byId('key'), bpm:byId('bpm'), notes:byId('notes'), file:byId('file'),
  addBtn:byId('addBtn'), exportBtn:byId('exportBtn'), importBtn:byId('importBtn'), importFile:byId('importFile'),
  userRole:byId('userRole'), signBtn:byId('signBtn'), playbackRate:byId('playbackRate'),
  refreshBtn:byId('refreshBtn'), clearBtn:byId('clearBtn'), subtitle:byId('subtitle')
};
const state={list:[], q:'', filterTag:'', sortBy:'date', view:'catalog', rate:parseFloat(localStorage.getItem('bw_rate')||'1')};
els.playbackRate.value=String(state.rate);

function byId(id){return document.getElementById(id)}
function switchView(v){
  state.view=v; ['Catalog','Upload','Fav','Settings'].forEach(k=>els['tab'+k].classList.toggle('active', v.toLowerCase()===k.toLowerCase()));
  els.screenCatalog.style.display = v==='catalog'?'':'none';
  els.screenUpload.style.display  = v==='upload' ?'':'none';
  els.screenFav.style.display     = v==='fav'    ?'':'none';
  els.screenSettings.style.display= v==='settings'?'':'none';
  els.subtitle.textContent = v==='upload' ? 'Хуячим песенки' : v==='fav' ? 'Избранные треки' : v==='settings' ? 'Настраиваем движок' : 'Каталог наработок';
  window.scrollTo({top:0,behavior:'smooth'});
}
els.tabCatalog.onclick=()=>switchView('catalog');
els.tabUpload.onclick =()=>switchView('upload');
els.tabFav.onclick    =()=>{renderFav(); switchView('fav');}
els.tabSettings.onclick=()=>switchView('settings');

function escapeHtml(s){return (s||'').replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c]))}
function ext(name){const i=(name||'').lastIndexOf('.');return i>=0?name.slice(i):'.mp3'}

/* ===== Render ===== */
function render(){
  const q=state.q.toLowerCase(), tag=state.filterTag, sort=state.sortBy;
  let items = state.list.filter(t=>(!tag||t.tag===tag)&&(!q|| (t.title||'').toLowerCase().includes(q)||(t.notes||'').toLowerCase().includes(q)||(t.keySig||'').toLowerCase().includes(q)||(''+t.bpm).includes(q)||(t.tag||'').includes(q)));
  items = sort==='title' ? items.sort((a,b)=> (a.title||'').localeCompare(b.title||'')) : items.sort((a,b)=> (b.created||0)-(a.created||0));
  els.list.innerHTML = items.length? '' : `<div class="body hint">Пусто. Загрузите файл во вкладке «Загрузка».</div>`;
  for(const t of items) els.list.appendChild(renderItem(t));
  applyPlaybackRate();
}
function renderFav(){
  const ids=favSet(); const items=state.list.filter(t=>ids.has(t.id));
  els.favList.innerHTML = items.length? '' : `<div class="body hint">Ещё ничего не добавлено в избранное ⭐</div>`;
  for(const t of items) els.favList.appendChild(renderItem(t,true));
  applyPlaybackRate();
}
function renderItem(t, inFav=false){
  const row=document.createElement('div'); row.className='item';
  row.innerHTML=`
    <div class="star ${favHas(t.id)?'active':''}" title="Избранное" data-act="fav">★</div>
    <div>
      <div class="row" style="justify-content:space-between">
        <div class="nowrap"><strong>${escapeHtml(t.title||'Без названия')}</strong> <span class="time">• ${new Date(t.created||Date.now()).toLocaleString()}</span></div>
        <div class="time">${escapeHtml(t.tag||'')} ${(t.keySig||'')}${t.bpm?(' • '+t.bpm+' bpm'):''}</div>
      </div>
      <div class="hint" style="margin:6px 0">${escapeHtml(t.notes||'')}</div>
      <audio class="audio" controls src="${t.url}"></audio>
    </div>
    <div class="kv">
      <button class="btn muted" data-act="download">Скачать</button>
      <button class="btn ghost" data-act="delete">Удалить локально</button>
    </div>`;
  row.querySelector('[data-act="fav"]').onclick = ()=> favToggle(t.id);
  row.querySelector('[data-act="download"]').onclick=()=> downloadBlob(t.blob||null,(t.title||'track')+ext(t.fileName));
  row.querySelector('[data-act="delete"]').onclick=async()=>{ if(confirm('Удалить локальную копию?')){ await dbDelete(t.id); await load(); if(inFav) renderFav(); } };
  return row;
}
function applyPlaybackRate(){ document.querySelectorAll('audio').forEach(a=>{ a.playbackRate=state.rate; }); }

/* ===== Supabase: upload / fetch ===== */
async function uploadToSupabase(item,file){
  const {data:{user}}=await supabase.auth.getUser(); const uid=user?.id||'anon';
  const path=`${uid}/${Date.now()}_${file.name}`;
  const up=await supabase.storage.from('tracks').upload(path,file,{cacheControl:'3600',upsert:false,contentType:file.type||'audio/mpeg'});
  if(up.error) throw up.error;
  const pub=supabase.storage.from('tracks').getPublicUrl(path).data.publicUrl;
  const row={id:item.id,title:item.title||'',tag:item.tag||'idea',key_sig:item.keySig||'',bpm:item.bpm||'',notes:item.notes||'',file_path:path};
  const ins=await supabase.from('tracks').insert(row); if(ins.error) throw ins.error;
  return {...row,url:pub,created:Date.now()};
}
async function initialFetch(){
  const q=await supabase.from('tracks').select('*').order('created_at',{ascending:false});
  const list=(q.data||[]).map(x=>{
    const url=supabase.storage.from('tracks').getPublicUrl(x.file_path).data.publicUrl;
    return {id:x.id,title:x.title,tag:x.tag,keySig:x.key_sig,bpm:x.bpm,notes:x.notes,url,created:new Date(x.created_at).getTime()};
  });
  state.list=list; render();
}
function subscribeRealtime(){
  supabase.channel('bw-tracks')
  .on('postgres_changes',{event:'INSERT',schema:'public',table:'tracks'},p=>{
    const x=p.new; const url=supabase.storage.from('tracks').getPublicUrl(x.file_path).data.publicUrl;
    state.list=[{id:x.id,title:x.title,tag:x.tag,keySig:x.key_sig,bpm:x.bpm,notes:x.notes,url,created:new Date(x.created_at).getTime()},...state.list];
    if(state.view==='catalog' || state.view==='fav') { render(); renderFav(); }
  }).subscribe();
}

/* ===== Handlers ===== */
function updateAuthUI(){ els.userRole.textContent=localAuth.role==='member'?'Участник':'Гость'; els.signBtn.textContent=localAuth.role==='member'?'Выйти':'Войти'; }
els.signBtn.onclick=()=>{ if(localAuth.role==='member'){localAuth.signOut();updateAuthUI();return} const code=prompt('Код приглашения:'); if(code&&localAuth.signIn(code.trim())){updateAuthUI(); alert('Готово! Можно загружать.');} else alert('Неверный код.'); };

els.addBtn.onclick=async()=>{
  if(localAuth.role!=='member'){alert('Нужен код участника (кнопка «Войти»).'); return;}
  const f=els.file.files[0]; if(!f){alert('Выбери аудиофайл'); return;}
  const item={id:crypto.randomUUID(),title:els.title.value.trim(),tag:els.tag.value,keySig:els.key.value.trim(),bpm:els.bpm.value.trim(),notes:els.notes.value.trim()};
  try{
    await uploadToSupabase(item,f);
    const arr=await f.arrayBuffer(); const blob=new Blob([arr],{type:f.type||'audio/mpeg'}); const urlLocal=URL.createObjectURL(blob);
    await dbPut({...item,blob,url:urlLocal,created:Date.now(),fileName:f.name});
    els.title.value=els.key.value=els.bpm.value=els.notes.value=''; els.file.value='';
    switchView('catalog'); await load();
  }catch(e){console.error(e); alert('Ошибка загрузки: '+e.message);}
};

els.q.oninput = ()=>{state.q=els.q.value; render();}
els.tagFilter.oninput = ()=>{state.filterTag=els.tagFilter.value; render();}
els.sortBy.oninput = ()=>{state.sortBy=els.sortBy.value; render();}

els.exportBtn.onclick=async()=>{
  const data=await dbReadAll();
  const items=await Promise.all(data.map(async t=>{ const buf=await t.blob.arrayBuffer(); const b64=btoa(String.fromCharCode(...new Uint8Array(buf))); return {...t, blob:undefined, url:undefined, base64:b64, mime:'audio/mpeg'}; }));
  const file=new Blob([JSON.stringify({version:1,exported:Date.now(),items})],{type:'application/json'});
  downloadBlob(file,`bw_export_${new Date().toISOString().slice(0,10)}.json`);
};
els.importBtn.onclick=()=>els.importFile.click();
els.importFile.onchange=async()=>{
  const f=els.importFile.files[0]; if(!f) return;
  try{const data=JSON.parse(await f.text());
    for(const t of data.items||[]){const bin=Uint8Array.from(atob(t.base64),c=>c.charCodeAt(0));const blob=new Blob([bin],{type:t.mime||'audio/mpeg'}); const url=URL.createObjectURL(blob); await dbPut({...t,blob,url});}
    await load(); alert('Импортировано.');
  }catch(e){alert('Ошибка импорта: '+e.message)}
  els.importFile.value='';
};

els.playbackRate.oninput=()=>{ state.rate=parseFloat(els.playbackRate.value); localStorage.setItem('bw_rate',String(state.rate)); applyPlaybackRate(); };
els.refreshBtn.onclick=()=>initialFetch();
els.clearBtn.onclick=async()=>{ if(confirm('Удалить все локальные копии?')){ const db=await idb(); db.close(); indexedDB.deleteDatabase(DB); await load(); alert('Готово.'); } };

function downloadBlob(blob,name){ if(!blob){alert('Локальной копии нет. Скачай по ссылке из плеера.'); return } const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),4000); }
async function load(){ state.list=await dbReadAll(); render(); }

/* init */
updateAuthUI(); switchView('catalog'); load(); initialFetch(); subscribeRealtime();
</script>
</body>
</html>
